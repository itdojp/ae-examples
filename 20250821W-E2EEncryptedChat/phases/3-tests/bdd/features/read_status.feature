# language: ja
フィーチャ: 既読ステータス管理
  E2Eチャットアプリケーションのユーザーとして
  メッセージの既読状況をデバイス別に管理したい
  なぜなら どのデバイスでメッセージを確認したかを把握したいから

  背景:
    前提 システムが起動している
    かつ ユーザー "alice@example.com" が登録済み
    かつ ユーザー "bob@example.com" が登録済み
    かつ Alice が複数デバイスでログイン中:
      | デバイス名    | デバイスID  | 状態      |
      | スマートフォン | phone_001  | オンライン |
      | タブレット    | tablet_001 | オンライン |
      | PC          | pc_001     | オフライン |

  シナリオ: デバイス登録
    前提 Alice が新しいデバイス "laptop_001" を使用している
    もし Alice がログインする
    ならば デバイス "laptop_001" が Alice のアカウントに登録される
    かつ デバイスがオンライン状態になる

  シナリオ: メッセージ送信時の初期既読ステータス
    もし Alice が Bob に "会議の件、確認お願いします" というメッセージを送信する
    ならば メッセージが送信される
    かつ 送信者 Alice の既読ステータスが自動的に記録される
    かつ 受信者 Bob の既読ステータスは未読である

  シナリオ: 単一デバイスでの既読
    前提 Alice から Bob にメッセージが送信済み
    かつ Bob がスマートフォン "phone_bob" でログイン中
    もし Bob がスマートフォンでメッセージを表示する
    ならば スマートフォンでの既読ステータスが記録される
    かつ 既読時刻が記録される
    かつ Alice に既読通知が送信される

  シナリオ: 複数デバイスでの個別既読管理
    前提 Alice から Bob にメッセージが送信済み
    かつ Bob が以下のデバイスでログイン中:
      | デバイス名    | デバイスID   |
      | スマートフォン | phone_bob   |
      | PC          | pc_bob      |
    もし Bob がスマートフォンでメッセージを既読にする
    ならば スマートフォンの既読ステータスが記録される
    かつ PC の既読ステータスは未読のままである
    もし Bob が後でPCでもメッセージを表示する
    ならば PC の既読ステータスも個別に記録される
    かつ 両方のデバイスの既読履歴が保持される

  シナリオ: オフラインデバイスでの既読
    前提 Bob のタブレット "tablet_bob" がオフライン状態
    かつ Alice から Bob にメッセージが送信済み
    もし Bob がタブレットでオンラインになる
    かつ メッセージを表示する
    ならば タブレットでの既読ステータスが記録される
    かつ オンライン復帰後の既読として処理される

  シナリオ: グループ会話での既読ステータス
    前提 Alice, Bob, Charlie のグループ会話が存在する
    かつ Alice がグループにメッセージを送信済み
    もし Bob がスマートフォンでメッセージを既読にする
    かつ Charlie がPCでメッセージを既読にする
    ならば Alice に以下の既読情報が表示される:
      | ユーザー | デバイス    | 既読時刻      |
      | Bob     | スマートフォン | 2025-08-14 10:30 |
      | Charlie | PC        | 2025-08-14 10:35 |

  シナリオ: 既読ステータスのリアルタイム更新
    前提 Alice と Bob がリアルタイム接続中
    かつ Alice から Bob にメッセージが送信済み
    もし Bob がメッセージを既読にする
    ならば Alice の画面にリアルタイムで既読表示が更新される
    かつ 既読アイコン (✓✓) が表示される
    かつ 更新遅延が 200ms 以内である

  シナリオ: 既読ステータスの永続化
    前提 Bob がメッセージを既読にした
    かつ Bob がアプリケーションからログアウトした
    もし Bob が再度ログインする
    ならば 既読ステータスが保持されている
    かつ 既読済みメッセージが既読として表示される

  シナリオ: デバイス固有の既読時刻
    前提 Bob が複数デバイスでログイン中
    かつ Alice から Bob にメッセージが送信済み
    もし Bob が 10:00 にスマートフォンで既読にする
    かつ Bob が 10:30 にPCで既読にする
    ならば 各デバイスの既読時刻が個別に記録される:
      | デバイス    | 既読時刻 |
      | スマートフォン | 10:00   |
      | PC        | 10:30   |

  シナリオ: 既読ステータスの取得API
    前提 複数のメッセージに既読ステータスが存在する
    もし Alice が会話の既読ステータスを取得する
    ならば 以下の情報がAPI応答に含まれる:
      | メッセージID | ユーザー | デバイス | 既読時刻      |
      | msg_001    | Bob     | phone   | 2025-08-14 10:00 |
      | msg_001    | Bob     | pc      | 2025-08-14 10:30 |
      | msg_002    | Charlie | tablet  | 2025-08-14 10:45 |

  シナリオ: 大量既読データの処理
    前提 1000件のメッセージが存在する
    かつ 10人のユーザーがそれぞれ3台のデバイスで既読している
    もし Alice が全体の既読ステータスを取得する
    ならば レスポンス時間が 2秒以内である
    かつ 全ての既読データが正確に返される

  シナリオ: 不正な既読ステータス更新の防止
    前提 Alice から Bob にメッセージが送信済み
    もし Charlie (無関係なユーザー) がこのメッセージを既読にしようとする
    ならば アクセスが拒否される
    かつ エラーメッセージ "このメッセージへのアクセス権限がありません" が返される

  シナリオ: 既読ステータスの統計表示
    前提 グループ会話に10名が参加している
    かつ Alice がメッセージを送信済み
    かつ 7名が既読、3名が未読の状態
    もし Alice がメッセージの既読状況を確認する
    ならば 以下の統計が表示される:
      | 既読人数 | 未読人数 | 既読率 |
      | 7名     | 3名     | 70%   |