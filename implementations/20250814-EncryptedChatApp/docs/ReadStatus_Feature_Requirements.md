# 既読未読確認機能 - 要件仕様書

## 1. 概要

既存のE2E暗号化チャットアプリケーションに、メッセージの既読未読ステータス確認機能を追加する。
プライバシーとセキュリティを最優先とし、既存システムへの影響を最小限に抑える。

## 2. 機能要件

### 2.1 基本機能要件

#### FR-RS-001: メッセージ既読ステータス管理
- システムは各メッセージの既読未読ステータスを追跡できること
- 既読ステータスはメッセージ送信者にのみ表示されること
- 受信者が複数いる場合、個別の既読ステータスを管理できること

#### FR-RS-002: 既読通知機能
- 受信者がメッセージを既読した際、送信者に通知されること
- 既読通知は暗号化されて送信されること
- 既読通知の送信は受信者の設定で無効化できること

#### FR-RS-003: 既読ステータス表示
- 送信者はメッセージ一覧で既読未読ステータスを確認できること
- 既読ステータスは視覚的にわかりやすく表示されること
- グループチャットでは全員の既読ステータスを確認できること

#### FR-RS-004: 既読時刻記録
- 各メッセージの既読時刻が記録されること
- 既読時刻は送信者が確認できること
- 時刻情報は暗号化されて保存されること

#### FR-RS-005: 一括既読機能
- 受信者は複数のメッセージを一括で既読にできること
- 会話全体を既読にする機能を提供すること
- 一括既読時も個別の既読通知が送信されること

### 2.2 プライバシー要件

#### FR-RS-006: 既読ステータス制御
- 受信者は既読通知の送信可否を設定できること
- 設定変更は即座に反映されること
- デフォルト設定は既読通知有効とすること

#### FR-RS-007: 既読情報の暗号化
- 既読ステータス情報は暗号化されて保存されること
- 既読通知の送信も暗号化されること
- 既読時刻データも暗号化対象とすること

#### FR-RS-008: 情報最小化
- 既読ステータスはメッセージ送信者のみが確認可能であること
- 第三者に既読情報が漏洩しないこと
- 既読データは必要最小限の情報のみ保存すること

### 2.3 グループチャット対応

#### FR-RS-009: グループ既読管理
- グループチャットでメンバー別既読ステータスを管理できること
- 送信者は各メンバーの既読状況を確認できること
- 全員既読時に特別な表示を行うこと

#### FR-RS-010: グループ既読集計
- グループ内の既読率を表示できること
- 未読メンバー数を表示できること
- 既読メンバー一覧を確認できること

### 2.4 リアルタイム同期

#### FR-RS-011: リアルタイム既読更新
- 既読ステータスの変更はリアルタイムで送信者に通知されること
- WebSocket経由で即座に同期されること
- オフライン時の既読ステータスも同期されること

#### FR-RS-012: マルチデバイス同期
- 同一ユーザーの複数デバイス間で既読ステータスが同期されること
- デバイス間の既読状態に矛盾がないこと
- 最新の既読状態が全デバイスに反映されること

## 3. 非機能要件

### 3.1 セキュリティ要件

#### NFR-RS-001: 暗号化保護
- 既読ステータス情報はE2E暗号化で保護されること
- Perfect Forward Secrecyが維持されること
- 既読データの暗号化強度は既存メッセージと同等であること

#### NFR-RS-002: プライバシー保護
- 既読ステータスはメタデータを最小化すること
- 既読パターンから行動分析されないよう配慮すること
- データ削除時は既読ステータスも完全削除されること

### 3.2 パフォーマンス要件

#### NFR-RS-003: 応答性能
- 既読ステータス更新は100ms以内に完了すること
- 既読通知の送信は50ms以内に開始されること
- UI更新による既存機能の性能劣化がないこと

#### NFR-RS-004: スケーラビリティ
- 10,000人のグループチャットでも既読管理が可能であること
- 1日1億メッセージの既読ステータス処理が可能であること
- 既読データの増加がシステム性能に大きく影響しないこと

### 3.3 可用性要件

#### NFR-RS-005: 高可用性
- 既読機能の障害が既存チャット機能に影響しないこと
- 既読データの損失は許容されないこと
- 99.9%の可用性を維持すること

### 3.4 互換性要件

#### NFR-RS-006: 後方互換性
- 既読機能追加前のメッセージも正常に表示されること
- 古いクライアントとの互換性を維持すること
- 既存APIへの破壊的変更を避けること

## 4. 制約条件

### 4.1 技術制約

#### TC-RS-001: 既存アーキテクチャ保持
- 現在のヘキサゴナルアーキテクチャを維持すること
- 既存の暗号化実装に変更を加えないこと
- 新機能は既存モジュールと疎結合であること

#### TC-RS-002: データベース制約
- 既存テーブル構造への破壊的変更は禁止
- 新機能用テーブルは別途追加すること
- マイグレーション時のダウンタイムは最小化すること

### 4.2 運用制約

#### TC-RS-003: デプロイメント制約
- Blue-Greenデプロイメント戦略を維持すること
- ローリングアップデート中も既読機能が動作すること
- ロールバック時の既読データ整合性を保証すること

## 5. 受け入れ基準

### 5.1 機能受け入れ基準

#### AC-RS-001: 基本機能
- [ ] メッセージ送信後、受信者の既読ステータスが表示される
- [ ] 受信者がメッセージを既読すると、送信者にリアルタイム通知される
- [ ] グループチャットで全メンバーの既読状況が確認できる

#### AC-RS-002: セキュリティ
- [ ] 既読データがE2E暗号化されている
- [ ] 既読ステータスが第三者に漏洩しない
- [ ] 既存のセキュリティレベルが維持されている

#### AC-RS-003: パフォーマンス
- [ ] 既読ステータス更新が100ms以内で完了する
- [ ] 10,000人グループでの既読管理が可能
- [ ] 既存機能の性能劣化がない

### 5.2 品質受け入れ基準

#### AC-RS-004: 品質基準
- [ ] 新機能のテストカバレッジが90%以上
- [ ] 既存テストが全てパス
- [ ] セキュリティスキャンで新たな脆弱性が検出されない

## 6. ユースケース

### 6.1 基本ユースケース

#### UC-RS-001: 1対1チャットでの既読確認
**アクター**: メッセージ送信者
**前提条件**: メッセージが送信済み
**メインフロー**:
1. 送信者がチャット画面を開く
2. 送信したメッセージに「未読」マークが表示される
3. 受信者がメッセージを読む
4. 送信者の画面で「既読」マークに変更される
5. 既読時刻が表示される

#### UC-RS-002: グループチャットでの既読確認
**アクター**: メッセージ送信者
**前提条件**: グループメッセージが送信済み
**メインフロー**:
1. 送信者がグループチャット画面を開く
2. 送信したメッセージに「3/5人既読」等の表示がされる
3. メンバーがメッセージを読むたびに表示が更新される
4. 全員既読時に「全員既読」表示になる

#### UC-RS-003: 既読通知の無効化
**アクター**: メッセージ受信者
**前提条件**: 既読通知が有効
**メインフロー**:
1. 受信者が設定画面を開く
2. 「既読通知を送信」設定を無効にする
3. 以降、メッセージを読んでも既読通知が送信されない
4. 送信者側では「既読ステータス無効」と表示される

## 7. データモデル

### 7.1 既読ステータスエンティティ

```
MessageReadStatus {
  id: UUID
  messageId: UUID (Foreign Key)
  userId: UUID (既読したユーザー)
  readAt: DateTime (既読時刻)
  deviceId: String (既読したデバイス)
  encrypted: Boolean (暗号化フラグ)
  createdAt: DateTime
  updatedAt: DateTime
}
```

### 7.2 既読設定エンティティ

```
ReadStatusSettings {
  id: UUID
  userId: UUID (設定ユーザー)
  enableReadNotification: Boolean (既読通知有効)
  defaultGroupReadNotification: Boolean (グループ既読通知デフォルト)
  showReadTime: Boolean (既読時刻表示)
  createdAt: DateTime
  updatedAt: DateTime
}
```

## 8. API仕様概要

### 8.1 既読ステータス取得API
```
GET /api/messages/{messageId}/read-status
```

### 8.2 既読ステータス更新API
```
POST /api/messages/{messageId}/read
```

### 8.3 一括既読API
```
POST /api/conversations/{conversationId}/mark-all-read
```

### 8.4 既読設定API
```
GET/PUT /api/users/{userId}/read-status-settings
```

## 9. リスク

### 9.1 技術リスク

#### R-RS-001: 既存システム影響
**リスク**: 既読機能追加により既存機能が不安定になる
**軽減策**: 段階的実装、十分なテスト、フィーチャーフラグ使用

#### R-RS-002: パフォーマンス劣化
**リスク**: 既読データ増加によりシステム性能が劣化
**軽減策**: 適切なインデックス設計、データアーカイブ戦略

### 9.2 セキュリティリスク

#### R-RS-003: プライバシー侵害
**リスク**: 既読情報からユーザー行動が推測される
**軽減策**: 最小限データ保存、暗号化、設定による制御

#### R-RS-004: 暗号化強度低下
**リスク**: 既読データが暗号化の弱点となる
**軽減策**: 既存と同等の暗号化、定期的セキュリティ監査

## 10. 実装フェーズ

### Phase 1: 基本既読機能
- 1対1チャットの既読ステータス
- 基本的な既読通知

### Phase 2: グループ対応
- グループチャットの既読管理
- 既読集計機能

### Phase 3: 高度機能
- 一括既読機能
- 詳細な既読分析

### Phase 4: 最適化
- パフォーマンス最適化
- UI/UX改善

---

**作成日**: 2025-08-14T22:47:14.630Z
**バージョン**: 1.0
**ステータス**: 要件分析完了