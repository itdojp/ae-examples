# セキュリティ脅威モデル
# E2E暗号化チャットアプリケーション

## 脅威の概要

### 資産 (Assets)
1. **ユーザーメッセージ** - 機密性の高いチャット内容
2. **暗号化キー** - RSA秘密鍵、AES セッションキー
3. **ユーザー認証情報** - パスワード、JWT トークン
4. **メタデータ** - 送信者、受信者、タイムスタンプ
5. **既読ステータス** - ユーザーの行動パターン

### 脅威アクター (Threat Actors)
1. **外部攻撃者** - インターネット経由の悪意のある第三者
2. **内部脅威** - システム管理者、開発者
3. **国家レベル攻撃者** - 高度な技術を持つ組織
4. **ソーシャルエンジニアリング** - ユーザーを標的とした攻撃

## 脅威分析 (STRIDE)

### 1. Spoofing (なりすまし)
**脅威**: 攻撃者が正当なユーザーになりすます

**攻撃シナリオ**:
- 盗まれた認証情報を使用したログイン
- JWT トークンの偽造
- セッションハイジャック

**対策**:
- 強力なパスワードポリシー
- JWT 署名検証の実装
- セッションタイムアウトの設定
- HTTPS 必須化

**リスクレベル**: HIGH

### 2. Tampering (改ざん)
**脅威**: メッセージやデータの不正な変更

**攻撃シナリオ**:
- 通信中のメッセージ改ざん
- データベース内容の不正変更
- クライアント側暗号化の回避

**対策**:
- E2E暗号化による内容保護
- メッセージ整合性チェック (HMAC)
- デジタル署名の実装
- データベース暗号化

**リスクレベル**: HIGH

### 3. Repudiation (否認)
**脅威**: メッセージ送信者の否認

**攻撃シナリオ**:
- 送信者がメッセージ送信を否定
- システムログの改ざん
- 監査証跡の削除

**対策**:
- デジタル署名による送信者認証
- 改ざん不可能な監査ログ
- タイムスタンプサーバーの使用

**リスクレベル**: MEDIUM

### 4. Information Disclosure (情報漏洩)
**脅威**: 機密情報の不正な開示

**攻撃シナリオ**:
- 暗号化されていないデータの傍受
- メモリダンプからのキー抽出
- サイドチャネル攻撃
- メタデータ分析

**対策**:
- 強力なE2E暗号化 (RSA-OAEP + AES-GCM)
- メモリ内キーの適切な消去
- メタデータの最小化
- Perfect Forward Secrecy の実装

**リスクレベル**: CRITICAL

### 5. Denial of Service (サービス拒否)
**脅威**: サービスの可用性への攻撃

**攻撃シナリオ**:
- 大量のメッセージ送信
- WebSocket 接続の枯渇
- 暗号化処理のリソース消費攻撃
- ネットワーク帯域の消費

**対策**:
- レート制限の実装
- 接続数制限
- リソース監視とアラート
- DDoS 対策の実装

**リスクレベル**: MEDIUM

### 6. Elevation of Privilege (権限昇格)
**脅威**: 不正な権限の取得

**攻撃シナリオ**:
- 管理者権限の不正取得
- 他ユーザーのメッセージへのアクセス
- システム権限での任意コード実行

**対策**:
- 最小権限の原則
- ロールベースアクセス制御
- 入力値検証の徹底
- セキュアコーディング

**リスクレベル**: HIGH

## 重要な脅威シナリオ

### シナリオ 1: Man-in-the-Middle 攻撃
**概要**: 攻撃者が通信経路に割り込み、メッセージを傍受・改ざん

**対策**:
- HTTPS/TLS 1.3 の強制使用
- 証明書ピニング
- E2E暗号化による内容保護
- 公開鍵指紋の事前交換

### シナリオ 2: クライアント側攻撃
**概要**: マルウェアによるブラウザ内秘密鍵の盗取

**対策**:
- WebCrypto API の non-extractable キー
- セッションキーの定期更新
- クライアント側でのメモリ保護
- 異常なアクセスパターンの検出

### シナリオ 3: サーバー側データ漏洩
**概要**: データベース侵害によるユーザー情報の流出

**対策**:
- E2E暗号化によりサーバーでは復号不可
- メタデータの暗号化
- アクセスログの監視
- データベース暗号化

## リスク評価マトリックス

| 脅威 | 確率 | 影響度 | リスクレベル | 対策状況 |
|------|------|--------|-------------|----------|
| メッセージ傍受 | HIGH | CRITICAL | CRITICAL | 実装済み |
| 認証情報盗取 | MEDIUM | HIGH | HIGH | 実装済み |
| サービス拒否 | MEDIUM | MEDIUM | MEDIUM | 実装済み |
| 権限昇格 | LOW | HIGH | MEDIUM | 実装済み |
| キー漏洩 | LOW | CRITICAL | HIGH | 実装済み |

## セキュリティ実装方針

### 1. 暗号化
- **E2E暗号化**: RSA-OAEP 2048bit + AES-GCM 256bit
- **キー管理**: WebCrypto API non-extractable keys
- **キー交換**: 事前交換 + セッションキー更新

### 2. 認証・認可
- **認証**: JWT + bcrypt ハッシュ化
- **認可**: ユーザー単位のメッセージアクセス制御
- **セッション**: 24時間タイムアウト

### 3. 通信セキュリティ
- **プロトコル**: HTTPS/TLS 1.3 必須
- **WebSocket**: WSS (WebSocket Secure)
- **CORS**: 適切なオリジン制限

### 4. 監視・ログ
- **アクセスログ**: 全API呼び出しの記録
- **異常検知**: 大量アクセス、異常パターンの検出
- **監査**: セキュリティイベントの追跡可能性

---

**作成日**: 2025年8月14日  
**レビュー周期**: 3ヶ月  
**次回レビュー**: 2025年11月14日